{% extends 'admin/admin_base.html' %}
{% load static %}

{% block title %}My Fines - {{ system_name|default:"FBC Library System" }}{% endblock %}

{% block page_title %}My Fines{% endblock %}

{% block content %}
<!-- Classic Library Header -->
<div class="relative bg-gradient-to-r from-library-navy via-library-burgundy to-library-navy rounded-none shadow-2xl mb-12">
    <div class="absolute inset-0 bg-black opacity-10"></div>
    <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 1000 100\" fill=\"none\"><path d=\"M0,50 Q250,20 500,50 T1000,50 L1000,100 L0,100 Z\" fill=\"%23ffffff\" fill-opacity=\"0.03\"/></svg>');"></div>
    
    <div class="relative z-10 px-8 py-16">
        <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <!-- Classical Library Icon -->
                    <div class="w-20 h-20 bg-library-gold rounded-full flex items-center justify-center shadow-lg animate-glow">
                        <i class="fas fa-money-bill-wave text-2xl text-library-navy"></i>
                    </div>
                    <div>
                        <h1 class="font-serif text-5xl font-bold text-white mb-2 tracking-wide">
                            My 
                            <span class="text-library-gold">Fines</span>
                        </h1>
                        <p class="text-library-cream text-xl font-body italic">
                            "Responsibility leads to trust" - {{ user.get_full_name|default:user.username }}
                        </p>
                        <div class="flex items-center space-x-6 mt-4">
                            <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-lg px-4 py-2 backdrop-blur-sm">
                                <i class="fas fa-user-graduate text-library-gold"></i>
                                <span class="text-library-cream font-semibold">Student</span>
                            </div>
                            <div class="flex items-center space-x-2 bg-white bg-opacity-10 rounded-lg px-4 py-2 backdrop-blur-sm">
                                <i class="fas fa-receipt text-library-gold"></i>
                                <span class="text-library-cream">{{ fines.count }} Fine{{ fines.count|pluralize }}</span>
                            </div>
                            {% if pending_fines > 0 %}
                            <div class="flex items-center space-x-2 bg-red-500 bg-opacity-20 rounded-lg px-4 py-2 backdrop-blur-sm">
                                <i class="fas fa-exclamation-triangle text-red-300"></i>
                                <span class="text-red-200 font-semibold">Le {{ pending_fines }} Pending</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Classical Decorative Element -->
                <div class="hidden xl:block">
                    <div class="w-40 h-40 relative">
                        <div class="absolute inset-0 border-4 border-library-gold rounded-full animate-float opacity-30"></div>
                        <div class="absolute inset-4 border-2 border-library-cream rounded-full animate-float opacity-50" style="animation-delay: 1s;"></div>
                        <div class="absolute inset-8 bg-library-gold rounded-full flex items-center justify-center shadow-xl">
                            <i class="fas fa-calculator text-3xl text-library-navy"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Classical Statistics Section -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
    <!-- Total Fines Card -->
    <div class="group relative bg-white rounded-2xl shadow-xl border-l-4 border-library-navy overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2">
        <div class="absolute top-0 right-0 w-20 h-20 bg-library-navy opacity-5 rounded-bl-full"></div>
        <div class="relative p-8">
            <div class="flex items-center justify-between">
                <div>
                    <div class="w-12 h-12 bg-library-navy bg-opacity-10 rounded-xl flex items-center justify-center mb-4 group-hover:bg-opacity-20 transition-colors">
                        <i class="fas fa-receipt text-xl text-library-navy"></i>
                    </div>
                    <h3 class="font-serif text-3xl font-bold text-library-navy mb-2">Le {{ total_fines|floatformat:2|default:0 }}</h3>
                    <p class="text-gray-600 font-body">Total Fines</p>
                    <div class="mt-3 flex items-center text-blue-600 text-sm font-semibold">
                        <i class="fas fa-history mr-1"></i>
                        <span>All Time</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Fines Card -->
    <div class="group relative bg-white rounded-2xl shadow-xl border-l-4 border-library-burgundy overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2">
        <div class="absolute top-0 right-0 w-20 h-20 bg-library-burgundy opacity-5 rounded-bl-full"></div>
        <div class="relative p-8">
            <div class="flex items-center justify-between">
                <div>
                    <div class="w-12 h-12 bg-library-burgundy bg-opacity-10 rounded-xl flex items-center justify-center mb-4 group-hover:bg-opacity-20 transition-colors">
                        <i class="fas fa-clock text-xl text-library-burgundy"></i>
                    </div>
                    <h3 class="font-serif text-3xl font-bold text-library-burgundy mb-2">Le {{ pending_fines|floatformat:2|default:0 }}</h3>
                    <p class="text-gray-600 font-body">Pending Payment</p>
                    <div class="mt-3 flex items-center text-orange-600 text-sm font-semibold">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span>Requires Attention</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paid Fines Card -->
    <div class="group relative bg-white rounded-2xl shadow-xl border-l-4 border-library-sage overflow-hidden hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2">
        <div class="absolute top-0 right-0 w-20 h-20 bg-library-sage opacity-5 rounded-bl-full"></div>
        <div class="relative p-8">
            <div class="flex items-center justify-between">
                <div>
                    <div class="w-12 h-12 bg-library-sage bg-opacity-10 rounded-xl flex items-center justify-center mb-4 group-hover:bg-opacity-20 transition-colors">
                        <i class="fas fa-check-circle text-xl text-library-sage"></i>
                    </div>
                    <h3 class="font-serif text-3xl font-bold text-library-sage mb-2">Le {{ paid_fines|floatformat:2|default:0 }}</h3>
                    <p class="text-gray-600 font-body">Paid Fines</p>
                    <div class="mt-3 flex items-center text-green-600 text-sm font-semibold">
                        <i class="fas fa-check-circle mr-1"></i>
                        <span>Resolved</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Fines List -->
    {% if fines.exists %}
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <!-- Classical Header -->
            <div class="bg-gradient-to-r from-library-parchment to-library-cream border-b border-warm-gray-200 p-8">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-14 h-14 bg-library-navy rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-list text-white text-xl"></i>
                        </div>
                        <div>
                            <h2 class="font-serif text-2xl font-bold text-library-navy">Fine History</h2>
                            <p class="text-gray-600 font-body">Your complete fine records</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-library-parchment border-b-2 border-library-gold">
                        <tr>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Book</th>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Type</th>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Amount</th>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Date Issued</th>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Due Date</th>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Status</th>
                            <th class="px-8 py-6 text-left text-sm font-serif font-bold text-library-navy uppercase tracking-wide">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-warm-gray-100">
                        {% for fine in fines %}
                        <tr class="hover:bg-library-parchment hover:bg-opacity-30 transition-colors duration-200">
                            <td class="px-8 py-6">
                                <div class="flex items-center">
                                    {% if fine.book.cover_image %}
                                    <img class="h-12 w-10 object-cover rounded shadow-md" src="{{ fine.book.cover_image.url }}" alt="{{ fine.book.title }}">
                                    {% else %}
                                    <div class="h-12 w-10 bg-library-navy bg-opacity-10 rounded flex items-center justify-center">
                                        <i class="fas fa-book text-library-navy"></i>
                                    </div>
                                    {% endif %}
                                    <div class="ml-4">
                                        <div class="text-sm font-semibold text-library-navy font-serif">{{ fine.book.title|truncatechars:30 }}</div>
                                        <div class="text-sm text-gray-600 font-body">{{ fine.book.author|truncatechars:25 }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-6">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border
                                    {% if fine.fine_type == 'overdue' %}bg-yellow-50 text-yellow-700 border-yellow-200
                                    {% elif fine.fine_type == 'damage' %}bg-orange-50 text-orange-700 border-orange-200
                                    {% elif fine.fine_type == 'lost' %}bg-red-50 text-red-700 border-red-200
                                    {% else %}bg-gray-50 text-gray-700 border-gray-200{% endif %}">
                                    <i class="fas fa-{% if fine.fine_type == 'overdue' %}clock{% elif fine.fine_type == 'damage' %}exclamation-triangle{% elif fine.fine_type == 'lost' %}times-circle{% else %}info-circle{% endif %} mr-1"></i>
                                    {{ fine.get_fine_type_display }}
                                </span>
                            </td>
                            <td class="px-8 py-6">
                                <div class="text-sm font-bold text-library-burgundy font-serif">Le {{ fine.amount|floatformat:2 }}</div>
                            </td>
                            <td class="px-8 py-6 text-sm text-gray-600 font-body">
                                {{ fine.date_issued|date:"M j, Y" }}
                            </td>
                            <td class="px-8 py-6 text-sm text-gray-600 font-body">
                                {{ fine.due_date|date:"M j, Y" }}
                                {% if fine.due_date < today and fine.status == 'pending' %}
                                <div class="text-red-600 font-semibold text-xs mt-1">(Overdue)</div>
                                {% endif %}
                            </td>
                            <td class="px-8 py-6">
                                {% if fine.status == 'pending' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-library-burgundy bg-opacity-20 text-library-burgundy border border-library-burgundy border-opacity-30">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    Pending
                                </span>
                                {% elif fine.status == 'paid' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-library-sage bg-opacity-20 text-library-sage border border-library-sage border-opacity-30">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Paid
                                </span>
                                {% elif fine.status == 'cancelled' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 border border-gray-300">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    Cancelled
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-8 py-6">
                                <div class="flex items-center space-x-2">
                                    {% if fine.status == 'pending' %}
                                    <a href="{% url 'fbc_payments:process_payment' %}?fine_id={{ fine.id }}" 
                                       class="inline-flex items-center px-4 py-2 bg-library-gold text-library-navy text-xs font-semibold rounded-lg hover:bg-library-gold hover:bg-opacity-80 transition-all duration-200 transform hover:scale-105 shadow-sm">
                                        <i class="fas fa-credit-card mr-1"></i>
                                        Pay Now
                                    </a>
                                    {% endif %}
                                    <a href="{% url 'fbc_fines:fine_details' fine.id %}" 
                                       class="inline-flex items-center px-3 py-2 bg-library-parchment text-library-navy text-xs font-semibold rounded-lg hover:bg-library-cream transition-colors duration-200 border border-library-navy border-opacity-20">
                                        <i class="fas fa-eye mr-1"></i>
                                        View
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <!-- Classical Empty State -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="text-center py-20 px-8">
                <div class="w-32 h-32 bg-library-sage bg-opacity-10 rounded-full flex items-center justify-center mx-auto mb-8 animate-bounce">
                    <i class="fas fa-check-circle text-library-sage text-5xl"></i>
                </div>
                <h3 class="font-serif text-3xl font-bold text-library-navy mb-4">Excellent Record!</h3>
                <p class="text-gray-600 font-body text-lg mb-8 max-w-md mx-auto">
                    You have maintained a clean record with no outstanding fines. 
                    Keep up the responsible library usage!
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="{% url 'fbc_books:student_dashboard' %}" 
                       class="inline-flex items-center px-8 py-4 rounded-xl text-lg font-semibold text-white bg-gradient-to-r from-library-navy to-library-burgundy hover:from-library-burgundy hover:to-library-navy transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-2xl">
                        <i class="fas fa-arrow-left mr-3"></i>
                        Return to Dashboard
                    </a>
                    <a href="{% url 'fbc_books:my_books' %}" 
                       class="inline-flex items-center px-8 py-4 rounded-xl text-lg font-semibold text-library-navy bg-library-gold hover:bg-library-gold hover:bg-opacity-80 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-2xl">
                        <i class="fas fa-book mr-3"></i>
                        View My Books
                    </a>
                </div>
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// Add library-themed animations and interactions
document.addEventListener('DOMContentLoaded', function() {
    // Add entrance animations for cards
    const cards = document.querySelectorAll('.group');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease-out';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });

    // Add hover effects for table rows
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.01)';
            this.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });
});

// Enhanced payment function with library theme
function payFine(fineId, amount) {
    const confirmation = confirm(`üèõÔ∏è FBC Library Payment\n\nConfirm payment of Le ${amount.toFixed(2)}?\n\nThis will process immediately and update your record.`);
    
    if (confirmation) {
        const button = event.target.closest('a, button');
        const originalHTML = button.innerHTML;
        
        // Show loading state with library styling
        button.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Processing...';
        button.classList.add('opacity-75', 'cursor-not-allowed');
        
        fetch(`/fines/pay/${fineId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success notification with library theme
                showLibraryNotification('Payment successful! Refreshing page...', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                button.innerHTML = originalHTML;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
                showLibraryNotification('Payment failed: ' + (data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Payment Error:', error);
            button.innerHTML = originalHTML;
            button.classList.remove('opacity-75', 'cursor-not-allowed');
            showLibraryNotification('Network error. Please try again.', 'error');
        });
    }
}

// Library-themed notification function
function showLibraryNotification(message, type) {
    const notification = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-library-sage' : 'bg-library-burgundy';
    
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-xl shadow-2xl z-50 transform translate-x-full transition-all duration-500 max-w-sm`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-3 text-xl"></i>
            <span class="font-semibold">${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Slide in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 500);
    }, 4000);
}
</script>
{% csrf_token %}
{% endblock %}
