<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - FBC Library</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .reader-toolbar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toolbar-hidden {
            transform: translateY(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .toolbar-visible {
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    <!-- Full Screen Reader -->
    <div id="reader-container" class="relative w-full h-screen">
        <!-- Top Toolbar -->
        <div id="reader-toolbar" class="reader-toolbar toolbar-visible fixed top-0 left-0 right-0 z-50 px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <a href="{% url 'fbc_books:book_detail' book.pk %}" 
                       class="inline-flex items-center px-3 py-2 bg-gray-700 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        Exit Reader
                    </a>
                    <div class="text-white">
                        <h1 class="text-lg font-semibold">{{ book.title }}</h1>
                        <p class="text-gray-300 text-sm">by {{ book.authors.all|join:", " }}</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-3">
                    <button onclick="toggleFullscreen()" 
                            class="inline-flex items-center px-3 py-2 bg-gray-700 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors">
                        <i class="fas fa-expand mr-2"></i>
                        <span id="fullscreen-text">Fullscreen</span>
                    </button>
                    
                    <a href="{% url 'fbc_books:ebook_download' book.pk %}" 
                       class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-download mr-2"></i>
                        Download
                    </a>
                    
                    <button onclick="toggleToolbar()" 
                            class="inline-flex items-center px-3 py-2 bg-gray-700 text-white text-sm font-medium rounded-md hover:bg-gray-600 transition-colors">
                        <i class="fas fa-eye-slash mr-2"></i>
                        Hide Toolbar
                    </button>
                </div>
            </div>
        </div>

        <!-- PDF Viewer -->
        <div class="w-full h-full">
            <iframe 
                id="pdf-viewer"
                src="{{ pdf_url }}#toolbar=1&navpanes=1&scrollbar=1&view=FitH" 
                class="w-full h-full border-0"
                title="PDF Reader - {{ book.title }}">
                <div class="flex items-center justify-center h-full bg-gray-800 text-white">
                    <div class="text-center">
                        <i class="fas fa-file-pdf text-6xl text-red-500 mb-4"></i>
                        <p class="text-xl mb-4">Unable to display PDF in browser</p>
                        <a href="{% url 'fbc_books:ebook_download' book.pk %}" 
                           class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>
                            Download PDF
                        </a>
                    </div>
                </div>
            </iframe>
        </div>

        <!-- Floating Controls (shown when toolbar is hidden) -->
        <div id="floating-controls" class="hidden fixed bottom-6 right-6 z-50">
            <div class="flex flex-col space-y-2">
                <button onclick="toggleToolbar()" 
                        class="w-12 h-12 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors shadow-lg">
                    <i class="fas fa-bars"></i>
                </button>
                <button onclick="toggleFullscreen()" 
                        class="w-12 h-12 bg-gray-800 text-white rounded-full hover:bg-gray-700 transition-colors shadow-lg">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Reading Progress Indicator -->
    <div id="progress-bar" class="fixed bottom-0 left-0 right-0 h-1 bg-gray-800 z-40">
        <div class="h-full bg-fbc-green-500 transition-all duration-300" style="width: 0%"></div>
    </div>

    <script>
        let toolbarVisible = true;
        let isFullscreen = false;

        // Toggle toolbar visibility
        function toggleToolbar() {
            const toolbar = document.getElementById('reader-toolbar');
            const floatingControls = document.getElementById('floating-controls');
            
            toolbarVisible = !toolbarVisible;
            
            if (toolbarVisible) {
                toolbar.classList.remove('toolbar-hidden');
                toolbar.classList.add('toolbar-visible');
                floatingControls.classList.add('hidden');
            } else {
                toolbar.classList.remove('toolbar-visible');
                toolbar.classList.add('toolbar-hidden');
                floatingControls.classList.remove('hidden');
            }
        }

        // Toggle fullscreen mode
        function toggleFullscreen() {
            const elem = document.documentElement;
            const fullscreenText = document.getElementById('fullscreen-text');
            
            if (!isFullscreen) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.mozRequestFullScreen) { /* Firefox */
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE/Edge */
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { /* Firefox */
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE/Edge */
                    document.msExitFullscreen();
                }
            }
        }

        // Listen for fullscreen changes
        document.addEventListener('fullscreenchange', function() {
            isFullscreen = !isFullscreen;
            const fullscreenText = document.getElementById('fullscreen-text');
            const icon = fullscreenText.previousElementSibling;
            
            if (isFullscreen) {
                fullscreenText.textContent = 'Exit Fullscreen';
                icon.className = 'fas fa-compress mr-2';
            } else {
                fullscreenText.textContent = 'Fullscreen';
                icon.className = 'fas fa-expand mr-2';
            }
        });

        // Auto-hide toolbar after inactivity
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (!toolbarVisible) {
                inactivityTimer = setTimeout(() => {
                    // Auto-hide could be implemented here
                }, 3000);
            }
        }

        // Track mouse movement for auto-hide functionality
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            switch(event.key) {
                case 'Escape':
                    if (toolbarVisible) {
                        window.location.href = "{% url 'fbc_books:book_detail' book.pk %}";
                    } else {
                        toggleToolbar();
                    }
                    break;
                case 'f':
                case 'F':
                    if (event.ctrlKey || event.metaKey) {
                        event.preventDefault();
                        toggleFullscreen();
                    }
                    break;
                case 't':
                case 'T':
                    toggleToolbar();
                    break;
            }
        });

        // Show keyboard shortcuts hint
        setTimeout(() => {
            if (!localStorage.getItem('reader-hints-shown')) {
                const hint = document.createElement('div');
                hint.className = 'fixed top-20 right-6 bg-gray-800 text-white p-4 rounded-lg shadow-lg z-50 fade-in';
                hint.innerHTML = `
                    <div class="text-sm">
                        <p class="font-semibold mb-2">Keyboard Shortcuts:</p>
                        <p><kbd class="bg-gray-700 px-1 rounded">T</kbd> - Toggle toolbar</p>
                        <p><kbd class="bg-gray-700 px-1 rounded">Ctrl+F</kbd> - Fullscreen</p>
                        <p><kbd class="bg-gray-700 px-1 rounded">Esc</kbd> - Exit reader</p>
                    </div>
                `;
                document.body.appendChild(hint);
                
                setTimeout(() => {
                    hint.remove();
                }, 5000);
                
                localStorage.setItem('reader-hints-shown', 'true');
            }
        }, 2000);
    </script>
</body>
</html>
