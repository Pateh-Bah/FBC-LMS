{% extends "admin/admin_base.html" %}
{% load static %}

{% block page_title %}Preview: {{ book.title }}{% endblock %}

{% block content %}
<div class="content-area p-6 animate-fade-in">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 bg-white rounded-xl shadow-sm border border-fbc-green-200 p-6">
        <div class="mb-4 md:mb-0">
            <h1 class="text-3xl font-serif font-bold text-fbc-navy-800 mb-2">
                <i class="fas fa-book-open text-fbc-green-500 mr-2"></i>
                {{ book.title }}
            </h1>
            <p class="text-fbc-navy-600 font-body text-lg">
                By: {% for author in book.authors.all %}{{ author.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
            </p>
            <div class="flex items-center space-x-4 mt-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                    <i class="fas fa-tablet-alt mr-1"></i>E-Book
                </span>
                {% if book.category %}
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-fbc-green-100 text-fbc-green-800">
                    <i class="fas fa-tag mr-1"></i>{{ book.category.name }}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-3 flex-wrap">
            <a href="{% url 'fbc_books:book_detail' book.pk %}" 
               class="bg-fbc-navy-700 hover:bg-fbc-navy-600 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 flex items-center space-x-2">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Details</span>
            </a>
            <a href="{% url 'fbc_books:ebook_reader' book.pk %}" 
               class="bg-fbc-green-600 hover:bg-fbc-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 flex items-center space-x-2">
                <i class="fas fa-expand-arrows-alt"></i>
                <span>Full Screen Reader</span>
            </a>
            <a href="{% url 'fbc_books:ebook_download' book.pk %}" 
               class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-300 flex items-center space-x-2">
                <i class="fas fa-download"></i>
                <span>Download</span>
            </a>
        </div>
    </div>

    <!-- PDF Viewer Section -->
    <div class="bg-white rounded-xl shadow-lg border border-fbc-green-200 overflow-hidden">
        <div class="bg-gradient-to-r from-fbc-green-600 to-fbc-green-500 px-6 py-4">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-serif font-bold text-white">
                    <i class="fas fa-eye mr-2"></i>Book Preview
                </h3>
                <div class="flex items-center space-x-2 text-white text-sm">
                    <i class="fas fa-info-circle"></i>
                    <span>Click to zoom or use browser controls</span>
                </div>
            </div>
        </div>
        
        <!-- PDF Viewer Options -->
        <div class="p-6 space-y-6">
            <!-- Option 1: Direct Link -->
            <div class="bg-gray-50 rounded-lg p-6 text-center">
                <i class="fas fa-file-pdf text-red-500 text-4xl mb-4"></i>
                <h4 class="text-lg font-semibold mb-2">View PDF Document</h4>
                <p class="text-gray-600 mb-4 font-body">Click below to open the PDF in your browser's built-in viewer</p>
                <a href="{{ pdf_url }}" target="_blank" 
                   class="inline-flex items-center px-6 py-3 bg-fbc-green-600 hover:bg-fbc-green-700 text-white font-semibold rounded-lg transition-all duration-300 shadow-md hover:shadow-lg">
                    <i class="fas fa-external-link-alt mr-2"></i>
                    Open PDF in New Tab
                </a>
            </div>

            <!-- Option 2: Embed (if supported) -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="text-center mb-4">
                    <button onclick="showEmbedViewer()" id="embed-button" 
                            class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-all duration-300">
                        <i class="fas fa-eye mr-2"></i>
                        View PDF Here
                    </button>
                </div>
                
                <!-- Embedded PDF Viewer -->
                <div id="pdf-embed-container" class="hidden">
                    <div style="height: 600px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <object id="pdf-object" 
                                data="{{ pdf_url }}" 
                                type="application/pdf" 
                                width="100%" 
                                height="100%">
                            <embed src="{{ pdf_url }}" 
                                   type="application/pdf" 
                                   width="100%" 
                                   height="100%" />
                        </object>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600 mb-2">Having trouble viewing? Try these alternatives:</p>
                        <div class="flex justify-center space-x-4">
                            <a href="{{ pdf_url }}" target="_blank" 
                               class="text-fbc-green-600 hover:text-fbc-green-700 underline">
                                Open in New Tab
                            </a>
                            <a href="{% url 'fbc_books:ebook_download' book.pk %}" 
                               class="text-blue-600 hover:text-blue-700 underline">
                                Download PDF
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Option 3: Google Docs Viewer (Fallback) -->
            <div class="bg-gray-50 rounded-lg p-6 text-center">
                <i class="fas fa-globe text-blue-500 text-4xl mb-4"></i>
                <h4 class="text-lg font-semibold mb-2">Alternative Viewer</h4>
                <p class="text-gray-600 mb-4 font-body">Use Google Docs viewer if the PDF doesn't display properly</p>
                <a href="https://docs.google.com/viewer?url=http://{{ request.get_host }}{{ pdf_url }}&embedded=true" target="_blank"
                   class="inline-flex items-center px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-all duration-300">
                    <i class="fas fa-external-link-alt mr-2"></i>
                    Open with Google Viewer
                </a>
            </div>
        </div>

        <!-- Reading Stats -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-center text-sm text-gray-600">
                <i class="fas fa-book mr-2"></i>
                <span>{{ book.title }} - Online Preview</span>
            </div>
        </div>
    </div>
</div>

<script>
function showEmbedViewer() {
    const container = document.getElementById('pdf-embed-container');
    const button = document.getElementById('embed-button');
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        button.textContent = 'Hide PDF Viewer';
        button.innerHTML = '<i class="fas fa-eye-slash mr-2"></i>Hide PDF Viewer';
    } else {
        container.classList.add('hidden');
        button.innerHTML = '<i class="fas fa-eye mr-2"></i>View PDF Here';
    }
}

// Test PDF loading
document.addEventListener('DOMContentLoaded', function() {
    console.log('PDF URL:', '{{ pdf_url }}');
    
    // Test if PDF URL is accessible
    fetch('{{ pdf_url }}', {method: 'HEAD'})
        .then(response => {
            if (response.ok) {
                console.log('PDF file is accessible');
            } else {
                console.log('PDF file might not be accessible:', response.status);
            }
        })
        .catch(error => {
            console.log('Error accessing PDF:', error);
        });
});
</script>
{% endblock %}
